/* ==================================================================================
 * bible.cs - 뱀파이어 서바이벌 스타일의 "성경책(King Bible)" 무기 구현
 * ==================================================================================
 * 
 * 이 스크립트는 뱀파이어 서바이벌 게임의 대표적인 무기인 "King Bible"을 구현합니다.
 * 
 * [King Bible 무기의 특징]
 * - 플레이어 주변을 원형으로 회전하는 성경책 오브젝트
 * - 회전하면서 접촉하는 적에게 데미지를 입힘
 * - 레벨업 시 성경책 개수, 회전 속도, 범위 등이 증가할 수 있음
 * 
 * [구현 원리]
 * - 삼각함수(Sin, Cos)를 사용하여 원형 궤도를 계산
 * - 매 프레임마다 각도를 증가시켜 회전 효과 구현
 * - 플레이어(부모 오브젝트) 위치를 중심으로 성경책들이 공전
 * 
 * 이 스크립트는 플레이어 오브젝트에 부착되어야 합니다.
 * ================================================================================== */

using System.Collections.Generic;  // List<T> 컬렉션을 사용하기 위한 네임스페이스
using UnityEngine;                  // Unity 엔진의 기본 기능들을 사용하기 위한 네임스페이스

/// <summary>
/// 플레이어 주위를 원형으로 회전하는 성경책(Bible) 무기를 관리하는 클래스
/// 이 컴포넌트는 플레이어 GameObject에 부착되어야 합니다.
/// </summary>
public class bible : MonoBehaviour
{
    /* ========================================
     * 멤버 변수 선언부
     * ======================================== */

    // ▼ 생성된 성경책 오브젝트들을 저장하는 리스트
    // 여러 개의 성경책을 관리하고, 각각의 위치를 업데이트하기 위해 사용
    private List<GameObject> bibles = new List<GameObject>();

    // ▼ 성경책 프리팹 (Inspector에서 할당)
    // [SerializeField]를 사용하여 private 변수이지만 Inspector에서 할당 가능
    // 이 프리팹은 성경책의 비주얼(스프라이트)과 충돌체(Collider)를 포함해야 함
    [SerializeField] GameObject biblePrefab;

    // ▼ 회전 속도 (도/초 단위)
    // 180도/초 = 2초에 한 바퀴 회전
    // 값이 클수록 빠르게 회전함
    float rotateSpeed = 180.0f;

    // ▼ 생성할 성경책의 개수
    // 레벨업 시 이 값을 증가시켜 성경책 수를 늘릴 수 있음
    // 현재는 1개로 시작
    int bibleCount = 1;

    // ▼ 성경책 간의 간격 (현재 미사용)
    // 추후 성경책끼리의 거리를 조절하는 용도로 사용 가능
    // 예: 성경책들 사이에 최소 간격을 유지하도록 구현할 때 활용
    float bibletobibleDis;

    // ▼ 플레이어와 성경책 사이의 거리 (반지름)
    // 이 값이 클수록 성경책이 플레이어로부터 멀리 떨어져서 회전
    // 현재 2.0 유닛 거리에서 회전
    float bibletoPlayerDis = 2.0f;

    // ▼ 현재 회전 각도 (도 단위)
    // 매 프레임마다 증가하며, 성경책의 위치 계산에 사용
    // 0도에서 시작하여 계속 증가 (360도 이상이 되어도 삼각함수는 정상 작동)
    float currentAngle = 0;

    /* ========================================
     * Unity 생명주기 메서드
     * ======================================== */

    /// <summary>
    /// Start: MonoBehaviour가 활성화될 때 한 번 호출됩니다.
    /// 게임 시작 시 초기 성경책을 생성합니다.
    /// </summary>
    void Start()
    {
        // 게임 시작 시 설정된 개수만큼 성경책을 생성
        BibleSpawn();
    }

    /// <summary>
    /// Update: 매 프레임마다 호출됩니다.
    /// 성경책의 회전 각도를 업데이트하고 위치를 재계산합니다.
    /// </summary>
    void Update()
    {
        // ▼ 현재 각도에 (회전속도 × 경과시간)을 더함
        // Time.deltaTime: 이전 프레임과 현재 프레임 사이의 시간 (프레임 독립적 이동 구현)
        // 예: rotateSpeed가 180이고 Time.deltaTime이 0.016(60fps)이면
        //     한 프레임당 약 2.88도씩 증가
        currentAngle += rotateSpeed * Time.deltaTime;

        // 모든 성경책의 위치를 새로운 각도에 맞게 업데이트
        UpdateBiblePos();
    }

    /* ========================================
     * 성경책 위치 업데이트 메서드
     * ======================================== */

    /// <summary>
    /// 모든 성경책의 위치를 원형 궤도 위에서 업데이트합니다.
    /// 삼각함수를 사용하여 원형 배치를 계산합니다.
    /// </summary>
    void UpdateBiblePos()
    {
        // ▼ 성경책들 사이의 각도 간격을 계산
        // 360도를 성경책 개수로 나누어 균등 배치
        // 예: 성경책이 4개면 각각 0도, 90도, 180도, 270도에 배치
        float step = 360f / bibleCount;

        // 각 성경책의 위치를 계산하여 업데이트
        for (int i = 0; i < bibleCount; i++)
        {
            // ▼ 이 성경책의 각도를 라디안으로 변환
            // currentAngle: 기본 회전 각도 (시간에 따라 증가)
            // step * i: 이 성경책의 오프셋 각도 (균등 분배)
            // Mathf.Deg2Rad: 도(degree)를 라디안(radian)으로 변환하는 상수
            //               (삼각함수는 라디안 단위를 사용하기 때문)
            float angle = (currentAngle + step * i) * Mathf.Deg2Rad;

            // ▼ 원형 궤도 위의 좌표 계산 (극좌표 → 직교좌표 변환)
            // 
            // [원의 방정식을 이용한 위치 계산]
            // 
            //        ┌─────────────────────────────────────┐
            //        │          (0, r)                     │
            //        │             ●                       │
            //        │            /│                       │
            //        │           / │                       │
            //        │        r /  │ r × sin(θ)            │
            //        │         /   │                       │
            //        │        /θ   │                       │
            //   (-r,0)●──────●─────●──────────●(r, 0)      │
            //        │     중심    r × cos(θ)              │
            //        │                                     │
            //        │          (0, -r)                    │
            //        └─────────────────────────────────────┘
            // 
            // x좌표: cos(θ) × 반지름
            // y좌표: sin(θ) × 반지름
            // z좌표: 0 (2D 게임이므로)
            //
            // Mathf.Cos(angle): 해당 각도의 코사인 값 (-1 ~ 1)
            // Mathf.Sin(angle): 해당 각도의 사인 값 (-1 ~ 1)
            // bibletoPlayerDis: 플레이어로부터의 거리 (반지름)
            Vector3 offset = new Vector3(Mathf.Cos(angle), Mathf.Sin(angle), 0) * bibletoPlayerDis;

            // ▼ 성경책의 최종 월드 위치 = 플레이어 위치 + 오프셋
            // transform.position: 이 스크립트가 부착된 오브젝트(플레이어)의 위치
            // 플레이어가 이동해도 성경책이 따라다니도록 매 프레임 계산
            bibles[i].transform.position = transform.position + offset;
        }
    }

    /* ========================================
     * 성경책 생성 메서드
     * ======================================== */

    /// <summary>
    /// 설정된 개수만큼 성경책 오브젝트를 생성합니다.
    /// 생성된 성경책은 리스트에 저장되어 관리됩니다.
    /// </summary>
    void BibleSpawn()
    {
        // bibleCount 만큼 성경책 프리팹을 인스턴스화
        for (int i = 0; i < bibleCount; i++)
        {
            // ▼ Instantiate: 프리팹을 복제하여 새로운 게임 오브젝트 생성
            // biblePrefab: 복제할 원본 프리팹
            // transform.position: 생성 위치 (현재는 플레이어 위치, 곧바로 UpdateBiblePos에서 재배치됨)
            // Quaternion.identity: 회전 없음 (기본 방향)
            GameObject Bible = Instantiate(biblePrefab, transform.position, Quaternion.identity);

            // ▼ 생성된 성경책을 리스트에 추가하여 추후 위치 업데이트에 사용
            bibles.Add(Bible);
        }
    }
}

/* ==================================================================================
 * [확장 아이디어 - 추후 구현할 수 있는 기능들]
 * ==================================================================================
 * 
 * 1. 레벨업 시스템 연동
 *    - bibleCount 증가 (성경책 개수 추가)
 *    - rotateSpeed 증가 (회전 속도 증가)
 *    - bibletoPlayerDis 증가 (범위 확대)
 *    
 *    public void LevelUp() {
 *        bibleCount++;
 *        BibleSpawn(); // 새로운 성경책 1개 추가 생성
 *    }
 * 
 * 2. 지속시간 & 쿨타임 시스템
 *    - 성경책이 일정 시간만 활성화되고, 쿨타임 후 다시 등장
 *    - 코루틴(Coroutine)을 사용하여 구현 가능
 * 
 * 3. 오브젝트 풀링 적용
 *    - 현재는 Instantiate로 직접 생성하지만,
 *      오브젝트 풀을 사용하면 성능 최적화 가능
 * 
 * 4. 데미지 시스템
 *    - biblePrefab에 Collider와 데미지 스크립트를 추가
 *    - OnTriggerEnter2D에서 적에게 데미지 적용
 * 
 * 5. 시각적 효과
 *    - 성경책 자체의 자전(회전) 추가
 *    - 트레일 이펙트 추가
 *    - 파티클 효과 추가
 * 
 * ================================================================================== */
